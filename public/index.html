<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ID Manager</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f9fafb; color:#111; margin:0; padding:0; }
  header { background:#e3f2fd; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
  header h2 { margin:0; font-size:18px; }
  header input { padding:5px; border:1px solid #ccc; border-radius:4px; }
  main { padding:20px; max-width:1200px; margin:auto; }
  table { width:100%; border-collapse:collapse; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  th, td { padding:6px 8px; border-bottom:1px solid #ddd; }
  th { background:#f1f5f9; text-align:left; }
  tr:hover { background:#f8fafc; }
  button { margin:4px; padding:6px 10px; border:1px solid #ccc; border-radius:4px; cursor:pointer; background:white; }
  button:hover { background:#e0f2fe; }
  textarea { width:100%; height:40px; resize:vertical; font-family:inherit; }
  .controls { margin-bottom:10px; display:flex; flex-wrap:wrap; gap:5px; align-items:center; }
  .pagination { text-align:center; margin-top:10px; }
  .pagination button { margin:2px; }
  .note { font-size:12px; color:#555; }
  .hidden { display:none; }
  #masterKeyContainer { position:fixed; top:10px; right:10px; background:#fff; padding:6px 10px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.2); font-size:13px; }
</style>
</head>
<body>
<header>
  <h2>üß© ID Manager</h2>
  <div id="masterKeyContainer">
    <label>Master key:</label>
    <input type="password" id="masterKeyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á" style="width:120px">
  </div>
</header>

<main>
  <div class="controls">
    <input id="filter" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
    <button onclick="load()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
    <button onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
    <button onclick="clearDB()">üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    <button onclick="toggleManualForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
  </div>

  <div id="manualForm" class="hidden">
    <input id="manualID" placeholder="ID..." />
    <input id="manualUser" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å..." />
    <button onclick="addManual()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <table id="idTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>ID</th>
        <th>–î–æ–±–∞–≤–∏–ª</th>
        <th>–ö–æ–≥–¥–∞</th>
        <th>–ó–∞–º–µ—Ç–∫–∞</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
</main>

<script>
let selected = new Set();
let items = [];
let total = 0;
let currentPage = 1;
const limit = 100;
let masterKey = localStorage.getItem("masterKey") || "";

document.getElementById("masterKeyInput").value = masterKey;
document.getElementById("masterKeyInput").addEventListener("input", e => {
  masterKey = e.target.value.trim();
  localStorage.setItem("masterKey", masterKey);
});

document.getElementById("filter").addEventListener("input", render);
document.getElementById("selectAll").addEventListener("change", e => {
  if (e.target.checked) items.forEach(x => selected.add(x.id));
  else selected.clear();
  render();
});

function toggleManualForm() {
  document.getElementById("manualForm").classList.toggle("hidden");
}

async function load(page = 1) {
  currentPage = page;
  const offset = (page - 1) * limit;
  const res = await fetch(`/api/list-full?limit=${limit}&offset=${offset}`);
  const data = await res.json();
  items = data.items;
  total = data.total;
  render();
}

function render() {
  const filter = document.getElementById("filter").value.toLowerCase();
  const tbody = document.querySelector("#idTable tbody");
  tbody.innerHTML = "";
  items
    .filter(x => x.id.toLowerCase().includes(filter) || x.added_by.toLowerCase().includes(filter))
    .forEach(x => {
      const tr = document.createElement("tr");
      const checked = selected.has(x.id) ? "checked" : "";
      tr.innerHTML = `
        <td><input type="checkbox" class="chk" data-id="${x.id}" ${checked}></td>
        <td>${x.id}</td>
        <td>${x.added_by}</td>
        <td>${new Date(x.created_at).toLocaleString()}</td>
        <td><textarea data-id="${x.id}">${x.note || ""}</textarea></td>
      `;
      tbody.appendChild(tr);
    });
  document.querySelectorAll(".chk").forEach(c =>
    c.addEventListener("change", e => {
      const id = e.target.dataset.id;
      if (e.target.checked) selected.add(id);
      else selected.delete(id);
    })
  );
  document.querySelectorAll("textarea").forEach(a =>
    a.addEventListener("change", async e => {
      const id = e.target.dataset.id;
      const note = e.target.value;
      await fetch("/api/note", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ id, note, masterKey })
      });
    })
  );
  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(total / limit);
  const container = document.getElementById("pagination");
  container.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) btn.style.background = "#90caf9";
    btn.onclick = () => load(i);
    container.appendChild(btn);
  }
}

async function deleteSelected() {
  if (!masterKey) return alert("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä –∫–ª—é—á!");
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?")) return;
  await fetch("/api/delete-multiple", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ids:[...selected], masterKey })
  });
  selected.clear();
  load(currentPage);
}

async function clearDB() {
  if (!masterKey) return alert("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä –∫–ª—é—á!");
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –í–°–Å –∏–∑ –±–∞–∑—ã?")) return;
  await fetch("/api/clear", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ masterKey })
  });
  load(1);
}

async function exportData() {
  const res = await fetch("/api/export");
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ids_export.json";
  a.click();
}

document.getElementById("importFile").addEventListener("change", async e => {
  if (!masterKey) return alert("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä –∫–ª—é—á!");
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("masterKey", masterKey);
  const res = await fetch("/api/import", { method:"POST", body:formData });
  if (!res.ok) alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
  load();
});

async function addManual() {
  const id = document.getElementById("manualID").value.trim();
  const added_by = document.getElementById("manualUser").value.trim();
  if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID!");
  if (!masterKey) return alert("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä –∫–ª—é—á!");
  await fetch("/api/add-manual", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id, added_by, masterKey })
  });
  document.getElementById("manualID").value = "";
  document.getElementById("manualUser").value = "";
  load(1);
}

load();
</script>
</body>
</html>
