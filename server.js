import express from "express";
import cors from "cors";
import pkg from "pg";

const { Pool } = pkg;
const app = express();
app.use(cors());
app.use(express.json());

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”
const pool = new Pool({
  connectionString: process.env.DATABASE_URL || "postgres://user:pass@host:5432/dbname",
  ssl: { rejectUnauthorized: false },
});

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
async function initDB() {
  await pool.query(`
    CREATE TABLE IF NOT EXISTS ids (
      id TEXT PRIMARY KEY,
      added_by TEXT,
      created_at TIMESTAMP DEFAULT NOW()
    );
  `);
  console.log("âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð° / ÑÐ¾Ð·Ð´Ð°Ð½Ð°");
}
initDB();

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ ID
app.get("/api/highlight-list", async (req, res) => {
  try {
    const result = await pool.query("SELECT id FROM ids");
    const ids = result.rows.map(r => r.id);
    res.json({ ids });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…" });
  }
});

// Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ ID
app.post("/api/add-id", async (req, res) => {
  try {
    const { id, apiKey } = req.body;
    if (!id || !apiKey) {
      return res.status(400).json({ error: "ID Ð¸Ð»Ð¸ API-ÐºÐ»ÑŽÑ‡ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚" });
    }

    await pool.query(
      `INSERT INTO ids (id, added_by) 
       VALUES ($1, $2) 
       ON CONFLICT (id) DO NOTHING`,
      [id, apiKey]
    );

    res.json({ success: true });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ID" });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ ID
app.get("/api/info/:id", async (req, res) => {
  try {
    const result = await pool.query(
      "SELECT * FROM ids WHERE id = $1",
      [req.params.id]
    );
    if (result.rows.length === 0) {
      return res.status(404).json({ error: "ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾" });
    }
    res.json(result.rows[0]);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°" });
  }
});

app.get("/", (req, res) => {
  res.send("âœ… ID API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚");
});

app.listen(process.env.PORT || 10000, () => {
  console.log("ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 10000");
});
