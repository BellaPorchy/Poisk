<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>ID Manager</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f8fafc; padding:20px; color:#111; }
  h2 { margin:0 0 10px 0; }
  .top { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  input[type="text"], input[type="date"], input[type="number"], input[type="password"] {
    padding:6px; border:1px solid #ccc; border-radius:4px;
  }
  button { margin:0 4px 8px 0; padding:6px 10px; border:1px solid #ccc; border-radius:4px; cursor:pointer; }
  table { width:100%; border-collapse:collapse; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); font-size:13px; margin-top:10px; }
  th, td { padding:6px 8px; border-bottom:1px solid #ddd; }
  th { background:#e0f0ff; text-align:left; }
  tr:hover { background:#f1f5f9; }
  textarea { width:100%; height:36px; font-size:12px; }
  #settings { margin-left:auto; display:flex; gap:8px; align-items:center; }
  #settings input { width:140px; }
  .note { font-size:12px; color:#444; }
  .small { font-size:12px; color:#666; }
  .pagination { text-align:center; margin-top:10px; }
</style>
</head>
<body>
  <div class="top">
    <h2>üß© ID Manager</h2>

    <div>
      <input id="filter" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
      <button onclick="refresh()">üîÑ</button>
      <button onclick="deleteSelected()">üóëÔ∏è</button>
      <button onclick="exportData()">üì§</button>
      <button onclick="document.getElementById('importFile').click()">üì•</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
    </div>

    <div id="settings">
      <label class="small">–ú–∏–Ω. –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:</label>
      <input id="minDuplicates" type="number" min="1" value="2">
      <label><input id="useMinDuplicates" type="checkbox" checked>        –í–∫–ª/–í—ã–∫–ª</label>
      <label class="small">–° –¥–∞—Ç—ã (–≤–∫–ª.):</label>
      <input id="minDate" type="date" value="2025-09-22">
      <label><input id="useMinDate" type="checkbox" checked>        –í–∫–ª/–í—ã–∫–ª</label>
      <button id="saveSettingsBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="clearDbBtn" style="background:#ffdede">üî• –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É</button>
    </div>
  </div>

  <div>
    <input id="newId" placeholder="–ù–æ–≤—ã–π ID" />
    <input id="newBy" placeholder="–î–æ–±–∞–≤–∏–ª (–∏–º—è)" />
    <button onclick="addManual()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <table id="idTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>ID</th>
        <th>–î–æ–±–∞–≤–∏–ª</th>
        <th>–ö–æ–≥–¥–∞</th>
        <th>–ó–∞–º–µ—Ç–∫–∞</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>

<script>
let items = [];
let currentPage = 1;
let totalPages = 1;
let selected = new Set();
let isSearching = false;

const MIN_DUP_INPUT = document.getElementById("minDuplicates");
const MIN_DATE_INPUT = document.getElementById("minDate");
const USE_MIN_DUP = document.getElementById("useMinDuplicates");
const USE_MIN_DATE = document.getElementById("useMinDate");
const SAVE_BTN = document.getElementById("saveSettingsBtn");
const CLEAR_BTN = document.getElementById("clearDbBtn");

async function loadSettingsToUI() {
  try {
    const res = await fetch("/api/settings");
    const s = await res.json();
    MIN_DUP_INPUT.value = s.minDuplicates || 2;
    MIN_DATE_INPUT.value = s.minDate || "2025-09-22";
    USE_MIN_DUP.checked = (s.useMinDuplicates === undefined) ? true : !!s.useMinDuplicates;
    USE_MIN_DATE.checked = (s.useMinDate === undefined) ? true : !!s.useMinDate;
  } catch (e) {
    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", e);
  }
}

SAVE_BTN.addEventListener("click", async () => {
  const minDuplicates = Number(MIN_DUP_INPUT.value || 2);
  const minDate = MIN_DATE_INPUT.value || "2025-09-22";
  const useMinDuplicates = USE_MIN_DUP.checked;
  const useMinDate = USE_MIN_DATE.checked;
  const masterKey = localStorage.getItem("master_key") || prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä –∫–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:");
  if (!masterKey) return alert("–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
  const res = await fetch("/api/settings", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ minDuplicates, minDate, useMinDuplicates, useMinDate, masterKey })
  });
  if (res.ok) {
    alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
  } else {
    const j = await res.json().catch(()=>({}));
    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + (j.error || res.status));
  }
});

document.getElementById("filter").addEventListener("input", async (e)=>{
  const q = e.target.value.trim();
  if (!q) { isSearching = false; load(currentPage); return; }
  isSearching = true;
  const res = await fetch(`/api/search?query=${encodeURIComponent(q)}`);
  const data = await res.json();
  items = data.items || [];
  render();
});

document.getElementById("selectAll").addEventListener("change", (e)=>{
  if (e.target.checked) {
    document.querySelectorAll(".chk").forEach(c => { c.checked = true; selected.add(c.dataset.id); });
  } else {
    selected.clear();
    document.querySelectorAll(".chk").forEach(c => c.checked = false);
  }
});

async function load(page = 1) {
  if (isSearching) return;
  const res = await fetch(`/api/list?page=${page}&limit=100`);
  const data = await res.json();
  items = data.items || [];
  totalPages = data.totalPages || 1;
  currentPage = data.page || page;
  render();
}

function render() {
  const tbody = document.querySelector("#idTable tbody");
  tbody.innerHTML = "";
  items.forEach(row => {
    const tr = document.createElement("tr");
    const checked = selected.has(String(row.id_pk || row.id)) ? "checked" : "";
    tr.innerHTML = `
      <td><input type="checkbox" class="chk" data-id="${row.id_pk || row.id}" ${checked}></td>
      <td>${row.id}</td>
      <td>${row.added_by}</td>
      <td>${new Date(row.created_at).toLocaleString()}</td>
      <td><textarea data-id="${row.id_pk || row.id}">${row.note || ""}</textarea></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".chk").forEach(c => c.addEventListener("change", e=>{
    const id = e.target.dataset.id;
    if (e.target.checked) selected.add(id); else selected.delete(id);
  }));

  document.querySelectorAll("textarea").forEach(a => a.addEventListener("change", async e=>{
    const idpk = e.target.dataset.id;
    const note = e.target.value;
    const masterKey = localStorage.getItem("master_key") || prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á:");
    if (!masterKey) return alert("–ù—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á");
    await fetch("/api/note", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ id_pk: idpk, note, masterKey })
    });
  }));

  const pag = document.getElementById("pagination");
  if (isSearching) {
    pag.innerHTML = `<span>üîé –ù–∞–π–¥–µ–Ω–æ ${items.length} –∑–∞–ø–∏—Å–µ–π</span>`;
  } else {
    let html = "";
    const range = 3;
    for (let i = Math.max(1, currentPage-range); i <= Math.min(totalPages, currentPage+range); i++) {
      html += `<button ${i===currentPage?'style="font-weight:bold;background:#cde4ff"':''} onclick="load(${i})">${i}</button>`;
    }
    pag.innerHTML = html;
  }
}

async function deleteSelected() {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?")) return;
  const masterKey = localStorage.getItem("master_key") || prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á:");
  if (!masterKey) return alert("–ù—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á");
  const arr = [...selected];
  await fetch("/api/delete-multiple", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ ids: arr, masterKey })
  });
  selected.clear();
  load(currentPage);
}

async function exportData() {
  const res = await fetch("/api/export");
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ids_export.json";
  a.click();
}

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const masterKey = localStorage.getItem("master_key") || prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á:");
  if (!masterKey) return alert("–ù—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á");
  const fd = new FormData();
  fd.append("file", f);
  fd.append("masterKey", masterKey);
  await fetch("/api/import", { method:"POST", body: fd });
  load(currentPage);
});

async function addManual() {
  const id = document.getElementById("newId").value.trim() || prompt("–í–≤–µ–¥–∏—Ç–µ ID:");
  if (!id) return;
  const added_by = document.getElementById("newBy").value.trim() || "manual";
  await fetch("/api/add-id", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body:JSON.stringify({ id, apiKey: added_by })
  });
  document.getElementById("newId").value = "";
  document.getElementById("newBy").value = "";
  load(1);
}

CLEAR_BTN.addEventListener("click", async () => {
  if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É?")) return;
  const masterKey = prompt("–í–≤–µ–¥–∏—Ç–µ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã:");
  if (!masterKey) return alert("–ù—É–∂–µ–Ω –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á");
  const res = await fetch("/api/clear", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ masterKey })
  });
  const j = await res.json().catch(()=>({}));
  if (j.success) {
    alert("–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞");
    load(1);
  } else {
    alert("–û—à–∏–±–∫–∞: " + (j.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"));
  }
});

function refresh() { load(currentPage); }

loadSettingsToUI().then(() => load());
setInterval(() => { if (!isSearching) load(currentPage); }, 5000);
</script>
</body>
</html>
