<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>ID Manager</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f8fafc; padding:20px; color:#111; }
  table { width:100%; border-collapse:collapse; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  th, td { padding:6px 8px; border-bottom:1px solid #ddd; }
  th { background:#e0f0ff; text-align:left; }
  tr:hover { background:#f1f5f9; }
  input, textarea { padding:6px; border:1px solid #ccc; border-radius:4px; }
  textarea { width:100%; height:38px; resize:none; }
  button { margin:3px; padding:6px 10px; border:1px solid #ccc; border-radius:4px; cursor:pointer; }
  button:hover { background:#e5f0ff; }
  #masterKeyInput { position:fixed; bottom:8px; right:8px; font-size:12px; width:130px; opacity:0.6; }
  #autoRefresh { position:fixed; bottom:8px; left:8px; font-size:12px; opacity:0.7; }
</style>
</head>
<body>
  <h2>üß© ID Manager</h2>
  <div>
    <input id="filter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ID –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
    <button onclick="refresh()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
    <button onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
    <button onclick="clearAll()">üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <br><br>
    <input id="newId" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π ID">
    <button onclick="addIdManual()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <table id="idTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>ID</th>
        <th>–î–æ–±–∞–≤–∏–ª</th>
        <th>–î–∞—Ç–∞</th>
        <th>–ó–∞–º–µ—Ç–∫–∞</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="pagination" style="margin-top:10px;"></div>

  <input id="masterKeyInput" placeholder="–ú–∞—Å—Ç–µ—Ä –∫–ª—é—á">
  <div id="autoRefresh">‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>

<script>
let selected = new Set();
let currentPage = 1, total = 0, items = [];
const limit = 100;
const autoRefreshEl = document.getElementById("autoRefresh");
const masterInput = document.getElementById("masterKeyInput");
masterInput.value = localStorage.getItem("master_key") || "";
masterInput.addEventListener("change", () => {
  localStorage.setItem("master_key", masterInput.value);
});

document.getElementById("selectAll").addEventListener("change", e => {
  const checked = e.target.checked;
  document.querySelectorAll(".chk").forEach(chk => {
    chk.checked = checked;
    if (checked) selected.add(chk.dataset.id);
    else selected.delete(chk.dataset.id);
  });
});

document.getElementById("filter").addEventListener("input", render);

async function load(page=1){
  currentPage = page;
  autoRefreshEl.textContent = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
  const res = await fetch(`/api/list-full?page=${page}&limit=${limit}`);
  const data = await res.json();
  items = data.items;
  total = data.total;
  render();
  renderPagination();
  autoRefreshEl.textContent = "‚úÖ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + new Date().toLocaleTimeString();
}

function render(){
  const filter = document.getElementById("filter").value.toLowerCase();
  const tbody = document.querySelector("#idTable tbody");
  tbody.innerHTML = "";
  items
    .filter(x => x.id.toLowerCase().includes(filter) || x.added_by.toLowerCase().includes(filter))
    .forEach(x => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="chk" data-id="${x.id}" ${selected.has(x.id)?"checked":""}></td>
        <td>${x.id}</td>
        <td>${x.added_by}</td>
        <td>${new Date(x.created_at).toLocaleString()}</td>
        <td><textarea data-id="${x.id}">${x.note||""}</textarea></td>
      `;
      tbody.appendChild(tr);
    });
  document.querySelectorAll(".chk").forEach(c=>c.addEventListener("change",e=>{
    const id=e.target.dataset.id;
    if(e.target.checked)selected.add(id); else selected.delete(id);
  }));
  document.querySelectorAll("textarea").forEach(a=>a.addEventListener("change",async e=>{
    const id=e.target.dataset.id, note=e.target.value;
    await fetch("/api/note",{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({id,note,masterKey:localStorage.getItem("master_key")||""})});
  }));
}

function renderPagination(){
  const totalPages=Math.ceil(total/limit);
  const c=document.getElementById("pagination");
  c.innerHTML="";
  if(totalPages<=1)return;
  const btn=(t,p,dis,a)=>{
    const b=document.createElement("button"); b.textContent=t;
    if(a)b.style.background="#90caf9";
    if(!dis)b.onclick=()=>load(p); else b.disabled=true;
    return b;
  };
  if(currentPage>1)c.appendChild(btn("‚Äπ",currentPage-1));
  let start=Math.max(1,currentPage-2), end=Math.min(totalPages,currentPage+2);
  if(start>1){c.appendChild(btn("1",1)); if(start>2)c.append("‚Ä¶");}
  for(let i=start;i<=end;i++)c.appendChild(btn(i,i,false,i===currentPage));
  if(end<totalPages){if(end<totalPages-1)c.append("‚Ä¶"); c.appendChild(btn(totalPages,totalPages));}
  if(currentPage<totalPages)c.appendChild(btn("‚Ä∫",currentPage+1));
}

async function deleteSelected(){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?"))return;
  await fetch("/api/delete-multiple",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({ids:[...selected],masterKey:localStorage.getItem("master_key")||""})});
  selected.clear(); load(currentPage);
}

async function exportData(){
  const res=await fetch("/api/export"); const blob=await res.blob();
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="ids_export.json"; a.click();
}

document.getElementById("importFile").addEventListener("change",async e=>{
  const f=e.target.files[0]; if(!f)return;
  const fd=new FormData(); fd.append("file",f);
  fd.append("masterKey",localStorage.getItem("master_key")||"");
  await fetch("/api/import",{method:"POST",body:fd}); load(currentPage);
});

async function clearAll(){
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?"))return;
  await fetch("/api/clear-all",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({masterKey:localStorage.getItem("master_key")||""})});
  load(1);
}

async function addIdManual(){
  const id=document.getElementById("newId").value.trim();
  if(!id)return alert("–í–≤–µ–¥–∏—Ç–µ ID");
  await fetch("/api/add-id",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({id,apiKey:"manual"})});
  document.getElementById("newId").value=""; load(1);
}

function refresh(){load(currentPage);}
setInterval(refresh,5000);
load();
</script>
</body>
</html>
