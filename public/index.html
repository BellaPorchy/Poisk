<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ID Manager</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f8fafc;
      padding: 20px;
      color: #111;
    }
    h2 { margin-bottom: 10px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 13px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #e0f0ff;
      text-align: left;
    }
    tr:hover { background: #f1f5f9; }
    input[type="text"] {
      padding: 6px;
      width: 250px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin: 4px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #e5f0ff; }
    textarea {
      width: 100%;
      height: 38px;
      font-size: 12px;
    }
    .note { font-size: 12px; color: #444; }
    .pagination {
      margin-top: 10px;
      text-align: center;
    }
    .pagination button {
      margin: 0 2px;
      padding: 4px 8px;
    }
    #master-container {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 13px;
    }
    #masterKey {
      padding: 4px;
      width: 130px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="master-container">
    üîë <input type="password" id="masterKey" placeholder="–ú–∞—Å—Ç–µ—Ä –∫–ª—é—á">
  </div>

  <h2>üß© ID Manager</h2>
  <div>
    <input id="filter" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
    <button onclick="refresh()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
    <button onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
    <button onclick="addManual()">‚ûï –î–æ–±–∞–≤–∏—Ç—å ID</button>
    <button onclick="clearAll()">üî• –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
  </div>

  <table id="idTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>ID</th>
        <th>–î–æ–±–∞–≤–∏–ª</th>
        <th>–ö–æ–≥–¥–∞</th>
        <th>–ó–∞–º–µ—Ç–∫–∞</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>

<script>
let selected = new Set();
let currentPage = 1;
let totalPages = 1;
let items = [];
let isSearching = false;
const PAGE_SIZE = 100;

document.getElementById("masterKey").value = localStorage.getItem("master_key") || "";
document.getElementById("masterKey").addEventListener("input", e => {
  localStorage.setItem("master_key", e.target.value);
});
const MASTER_KEY = () => document.getElementById("masterKey").value;

document.getElementById("filter").addEventListener("input", async (e) => {
  const query = e.target.value.trim();
  if (query.length === 0) {
    isSearching = false;
    load(currentPage);
    return;
  }
  isSearching = true;
  const res = await fetch(`/api/search?query=${encodeURIComponent(query)}`);
  const data = await res.json();
  items = data.items || [];
  render();
});

document.getElementById("selectAll").addEventListener("change", e => {
  const checkboxes = document.querySelectorAll(".chk");
  if (e.target.checked) {
    checkboxes.forEach(c => {
      c.checked = true;
      selected.add(c.dataset.id);
    });
  } else {
    selected.clear();
    checkboxes.forEach(c => c.checked = false);
  }
});

async function load(page = 1) {
  if (isSearching) return; 
  const res = await fetch(`/api/list?page=${page}`);
  const data = await res.json();
  items = data.items;
  totalPages = data.totalPages;
  currentPage = page;
  render();
}

function render() {
  const tbody = document.querySelector("#idTable tbody");
  tbody.innerHTML = "";
  (items || []).forEach(x => {
    const tr = document.createElement("tr");
    const checked = selected.has(x.id) ? "checked" : "";
    tr.innerHTML = `
      <td><input type="checkbox" class="chk" data-id="${x.id}" ${checked}></td>
      <td>${x.id}</td>
      <td>${x.added_by}</td>
      <td>${new Date(x.created_at).toLocaleString()}</td>
      <td><textarea data-id="${x.id}">${x.note || ""}</textarea></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".chk").forEach(c =>
    c.addEventListener("change", e => {
      const id = e.target.dataset.id;
      if (e.target.checked) selected.add(id);
      else selected.delete(id);
    })
  );

  document.querySelectorAll("textarea").forEach(a =>
    a.addEventListener("change", async e => {
      const id = e.target.dataset.id;
      const note = e.target.value;
      await fetch("/api/note", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ id, note, masterKey: MASTER_KEY() })
      });
    })
  );

  const p = document.getElementById("pagination");
  if (isSearching) {
    p.innerHTML = `<p>üîç –ù–∞–π–¥–µ–Ω–æ ${items.length} –∑–∞–ø–∏—Å–µ–π</p>`;
  } else {
    const btns = [];
    const range = 3;
    for (let i = Math.max(1, currentPage - range); i <= Math.min(totalPages, currentPage + range); i++) {
      btns.push(`<button ${i===currentPage?"style='font-weight:bold;background:#cde4ff'":""} onclick="load(${i})">${i}</button>`);
    }
    p.innerHTML = btns.join("");
  }
}

async function deleteSelected() {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?")) return;
  await fetch("/api/delete-multiple", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ids:[...selected], masterKey: MASTER_KEY() })
  });
  selected.clear();
  load();
}

async function exportData() {
  const res = await fetch("/api/export");
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ids_export.json";
  a.click();
}

document.getElementById("importFile").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("masterKey", MASTER_KEY());
  await fetch("/api/import", { method:"POST", body:formData });
  load();
});

async function addManual() {
  const id = prompt("–í–≤–µ–¥–∏—Ç–µ ID:");
  if (!id) return;
  const added_by = prompt("–ö—Ç–æ –¥–æ–±–∞–≤–∏–ª?");
  await fetch("/api/add-id", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id, apiKey: added_by || "manual" })
  });
  load();
}

async function clearAll() {
  if (!confirm("‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏?")) return;
  await fetch("/api/clear-all", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ masterKey: MASTER_KEY() })
  });
  load();
}

function refresh() { load(currentPage); }
setInterval(() => { if (!isSearching) load(currentPage); }, 5000);

load();
</script>
</body>
</html>
